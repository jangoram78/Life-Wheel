<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Life Wheel</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display","Inter",system-ui,sans-serif;
      background:#f4f7fa;
      color:#111;
      overscroll-behavior:none
    }
    body{
      display:flex;
      flex-direction:column
    }
    .app{
      flex:1;
      display:flex;
      flex-direction:column;
      max-width:480px;
      margin:0 auto;
      padding:2px 8px 70px;
    }
    .app-header{
      padding:0 2px 0;
      display:flex;
      justify-content:center;
      align-items:baseline;
      gap:6px;
    }
    .app-title{
      font-size:18px;
      font-weight:600;
      margin:0;
    }
    .app-subtitle{
      font-size:12px;
      color:#667;
      opacity:.9;
      white-space:nowrap;
    }
    .view{
      display:none;
      flex:1;
      overflow-y:auto;
      padding-bottom:44px
    }
    .view.active{display:block}
    .section{
      margin-top:2px;
      margin-bottom:3px;
    }
    .view > .section:first-child{
      margin-top:0;
    }
    .section-title{
      font-size:14px;
      font-weight:600;
      margin-bottom:3px;
      color:#445
    }
    .card{
      background:#fff;
      border-radius:14px;
      box-shadow:0 4px 14px rgba(15,23,42,.08),0 1px 3px rgba(15,23,42,.12);
      padding:8px 10px;
      margin-bottom:6px
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:2px;
      gap:4px
    }
    .card-title{
      font-size:13px;
      font-weight:500;
      color:#111;
      line-height:1.25;
      flex:1;
      min-width:0
    }
    .card-value{
      font-size:12px;
      color:#456;
      white-space:nowrap;
      margin-left:6px
    }
    .slider-row{
      display:flex;
      flex-direction:column;
      gap:2px
    }
    .slider-row input[type=range]{
      width:100%;
      -webkit-appearance:none;
      height:22px;
      background:transparent
    }
    .slider-row input[type=range]:focus{outline:none}
    .slider-row input[type=range]::-webkit-slider-runnable-track{
      height:4px;
      background:linear-gradient(90deg,#5da8ff,#a4c8ff);
      border-radius:999px
    }
    .slider-row input[type=range]::-moz-range-track{
      height:4px;
      background:linear-gradient(90deg,#5da8ff,#a4c8ff);
      border-radius:999px
    }
    .slider-row input[type=range]::-webkit-slider-thumb{
      -webkit-appearance:none;
      height:20px;
      width:20px;
      border-radius:50%;
      background:#fff;
      box-shadow:0 2px 6px rgba(15,23,42,.25);
      margin-top:-8px;
      border:1px solid rgba(148,163,184,.6)
    }
    .slider-row input[type=range]::-moz-range-thumb{
      height:18px;
      width:18px;
      border-radius:50%;
      background:#fff;
      box-shadow:0 2px 6px rgba(15,23,42,.25);
      border:1px solid rgba(148,163,184,.6)
    }
    .slider-value-label{
      font-size:11px;
      color:#667;
      text-align:right
    }
    .radar-wrapper{
      background:#fff;
      border-radius:14px;
      box-shadow:0 6px 18px rgba(15,23,42,.08),0 1px 3px rgba(15,23,42,.12);
      padding:0 4px 0;
      margin-bottom:0;
    }
    .radar-canvas-wrap{
      width:100%;
      position:relative
    }
    .radar-canvas-wrap canvas{
      width:100%;
      height:auto;
      display:block
    }
    .small-note{
      font-size:11px;
      color:#889;
      margin-top:4px
    }
    .settings-group{margin-bottom:10px}
    .settings-row{
      display:flex;
      align-items:center;
      gap:4px;
      margin-bottom:4px
    }
    .settings-row input{
      flex:1;
      border-radius:10px;
      border:1px solid #cbd5f1;
      padding:6px 8px;
      font-size:12px
    }
    .settings-row button{
      border:none;
      border-radius:999px;
      background:#fee2e2;
      color:#b91c1c;
      font-size:11px;
      padding:4px 8px;
      white-space:nowrap
    }
    .settings-row button.add{
      background:#dcfce7;
      color:#166534
    }
    .settings-hint{
      font-size:11px;
      color:#667;
      margin-bottom:4px
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      background:#5da8ff;
      color:#fff
    }
    .btn.outline{
      background:transparent;
      color:#2563eb;
      border:1px solid #bfdbfe
    }
    .toast{
      position:fixed;
      left:50%;
      bottom:68px;
      transform:translateX(-50%);
      background:#111;
      color:#fff;
      font-size:12px;
      padding:6px 12px;
      border-radius:999px;
      box-shadow:0 10px 25px rgba(15,23,42,.3);
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease,transform .25s ease;
      z-index:50
    }
    .toast.visible{
      opacity:1;
      transform:translateX(-50%) translateY(-4px)
    }
    .tabbar{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      padding:4px 10px 10px;
      z-index:40
    }
    .tabbar-inner{
      max-width:480px;
      margin:0 auto;
      background:rgba(255,255,255,.88);
      border-radius:20px;
      box-shadow:0 10px 30px rgba(15,23,42,.18),0 0 0 1px rgba(148,163,184,.25);
      backdrop-filter:blur(16px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:4px
    }
    .tab-btn{
      flex:1;
      border:none;
      background:transparent;
      padding:4px 2px;
      border-radius:999px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:1px;
      min-width:0
    }
    .tab-pill{
      border-radius:999px;
      padding:4px 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:1px;
      transition:background .16s ease,transform .16s ease
    }
    .tab-icon{
      font-size:14px;
      line-height:1
    }
    .tab-label{
      font-size:11px;
      white-space:nowrap
    }
    .tab-btn.active .tab-pill{
      background:rgba(93,168,255,.16);
      transform:translateY(-1px)
    }
    .tab-btn.active .tab-label{
      font-weight:600;
      color:#1d4ed8
    }
    @supports not (backdrop-filter:blur(10px)){
      .tabbar-inner{background:#fff}
    }

    /* Insights-specific */
    .insights-stack{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .insights-row{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      margin-top:2px;
    }
    .insights-label{
      font-size:12px;
      color:#111;
    }
    .insights-score{
      font-size:12px;
      color:#334155;
    }
    .insights-delta{
      font-size:11px;
      margin-left:6px;
    }
    .insights-secondary{
      font-size:11px;
      color:#64748b;
      margin-top:2px;
    }

    /* Today-specific */
    .today-stack{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .badge-neglect{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      margin-left:6px;
      border:1px solid transparent;
    }
    .badge-none{
      background:#dcfce7;
      color:#166534;
      border-color:#bbf7d0;
    }
    .badge-medium{
      background:#fef9c3;
      color:#854d0e;
      border-color:#fde68a;
    }
    .badge-serious{
      background:#fee2e2;
      color:#b91c1c;
      border-color:#fecaca;
    }
    .today-domain-row{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      margin-top:2px;
    }
    .today-domain-label{
      font-size:12px;
      color:#111;
    }
    .today-domain-score{
      font-size:12px;
      color:#334155;
      white-space:nowrap;
      display:flex;
      align-items:baseline;
    }

    /* Tasks */
    .task-group-title{
      font-size:11px;
      font-weight:600;
      color:#475569;
      margin-top:2px;
      margin-bottom:2px;
    }
    .task-stack{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .task-row{
      display:flex;
      align-items:flex-start;
      gap:6px;
      font-size:12px;
      color:#111;
    }
    .task-checkbox{
      width:16px;
      height:16px;
      margin-top:1px;
    }
    .task-main{
      flex:1;
      min-width:0;
    }
    .task-label{
      font-size:12px;
      line-height:1.3;
    }
    .task-meta{
      font-size:11px;
      color:#64748b;
      margin-top:1px;
    }
    .task-domain-chip{
      font-size:10px;
      padding:1px 6px;
      border-radius:999px;
      background:#eff6ff;
      color:#1d4ed8;
      display:inline-block;
      margin-top:1px;
    }
    .task-done .task-label{
      text-decoration:line-through;
      color:#9ca3af;
    }
    .task-done .task-meta{
      color:#9ca3af;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="app-header">
      <div class="app-title">Life Wheel</div>
      <div class="app-subtitle" id="periodLabel"></div>
    </div>

    <!-- TODAY VIEW -->
    <div id="todayView" class="view active">
      <div class="section">
        <div class="section-title">Today</div>
        <div id="todayContent"></div>
      </div>
    </div>

    <!-- WEEKLY VIEW -->
    <div id="weeklyView" class="view">
      <div class="section">
        <div class="radar-wrapper">
          <div class="radar-canvas-wrap">
            <canvas id="weeklyRadar"></canvas>
          </div>
        </div>
      </div>
      <div class="section">
        <div class="section-title">Weekly scores</div>
        <div id="weeklyDomains"></div>
      </div>
    </div>

    <!-- INSIGHTS VIEW -->
    <div id="insightsView" class="view">
      <div class="section">
        <div class="section-title">Weekly insights</div>
        <div id="insightsContent"></div>
      </div>
    </div>

    <!-- MONTHLY VIEW -->
    <div id="monthlyView" class="view">
      <div class="section">
        <div class="section-title">Monthly subdomain scores</div>
        <div id="monthlyDomains"></div>
      </div>
    </div>

    <!-- SETTINGS VIEW -->
    <div id="settingsView" class="view">
      <div class="section">
        <div class="section-title">Domains</div>
        <div class="settings-hint">
          Edit your life domains. Changes affect weekly and monthly views.
        </div>
        <div id="settingsDomains"></div>
        <button id="addDomainBtn" class="btn" style="margin-top:4px;">+ Add domain</button>
      </div>
      <div class="section">
        <div class="section-title">Info</div>
        <div class="card">
          <div class="small-note">
            Data is stored locally on this device using your browser's storage.
            Clearing site data will reset your scores.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Saved ‚úì</div>

  <div class="tabbar">
    <div class="tabbar-inner">
      <button class="tab-btn active" data-view="todayView">
        <div class="tab-pill">
          <div class="tab-icon">üåÖ</div>
          <div class="tab-label">Today</div>
        </div>
      </button>
      <button class="tab-btn" data-view="weeklyView">
        <div class="tab-pill">
          <div class="tab-icon">üóìÔ∏è</div>
          <div class="tab-label">Weekly</div>
        </div>
      </button>
      <button class="tab-btn" data-view="insightsView">
        <div class="tab-pill">
          <div class="tab-icon">üìò</div>
          <div class="tab-label">Insights</div>
        </div>
      </button>
      <button class="tab-btn" data-view="monthlyView">
        <div class="tab-pill">
          <div class="tab-icon">üìä</div>
          <div class="tab-label">Monthly</div>
        </div>
      </button>
      <button class="tab-btn" data-view="settingsView">
        <div class="tab-pill">
          <div class="tab-icon">‚öôÔ∏è</div>
          <div class="tab-label">Settings</div>
        </div>
      </button>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      // Build marker ‚Äì bump this each release
      var APP_VERSION = "U7";

      // Storage keys
      var STORAGE_KEY_DOMAINS = "lw_domains_v3";      // 6-domain model
      var STORAGE_KEY_WEEKLY  = "lw_weekly_scores_v3";
      var STORAGE_KEY_MONTHLY = "lw_monthly_scores_v3";
      var STORAGE_KEY_TASKS   = "lw_tasks_v1";

      // Definitive domain + subdomain model, in aesthetic wheel order:
      // Mental ‚Üí Physical ‚Üí Work & Purpose ‚Üí Social ‚Üí Emotional ‚Üí Spiritual
      var defaultDomains = [
        { name:"Mental",          sub:["Logic","Knowledge","Skill"] },
        { name:"Physical",        sub:["Strength","Stamina","Health","Mobility"] },
        { name:"Work & Purpose",  sub:["Career","Mastery","Finance","Legacy"] },
        { name:"Social",          sub:["Family","Friends","Colleagues","Civic Contribution"] },
        { name:"Emotional",       sub:["Emotional Stability & Regulation","Joy","Identity"] },
        { name:"Spiritual",       sub:["Philosophy","Virtue"] }
      ];

      function loadJSON(key,fallback){
        try{
          var raw=localStorage.getItem(key);
          if(!raw)return fallback;
          var parsed=JSON.parse(raw);
          return parsed||fallback;
        }catch(e){return fallback}
      }
      function saveJSON(key,val){
        try{localStorage.setItem(key,JSON.stringify(val))}catch(e){}
      }

      function getWeekKey(){
        var d=new Date(),year=d.getFullYear(),oneJan=new Date(year,0,1);
        var dayMS=24*60*60*1000;
        var diff=d-oneJan;
        var day=oneJan.getDay()||7;
        var week=Math.ceil(((diff/dayMS)+day)/7);
        return year+"-W"+(week<10?"0"+week:week);
      }
      function getMonthKey(){
        var d=new Date(),year=d.getFullYear(),m=d.getMonth()+1;
        return year+"-"+(m<10?"0"+m:m);
      }
      function getPreviousWeekKeyFromToday(){
        var d=new Date();
        d.setDate(d.getDate()-7);
        var year=d.getFullYear(),oneJan=new Date(year,0,1);
        var dayMS=24*60*60*1000;
        var diff=d-oneJan;
        var day=oneJan.getDay()||7;
        var week=Math.ceil(((diff/dayMS)+day)/7);
        return year+"-W"+(week<10?"0"+week:week);
      }
      function getTodayKey(){
        var d=new Date();
        var y=d.getFullYear();
        var m=d.getMonth()+1;
        var dm=d.getDate();
        var mm=(m<10?"0"+m:m);
        var dd=(dm<10?"0"+dm:dm);
        return y+"-"+mm+"-"+dd;
      }

      var state={
        domains:[],
        weeklyScores:{},
        monthlyScores:{},
        tasksByDate:{},
        weekKey:getWeekKey(),
        monthKey:getMonthKey(),
        todayKey:getTodayKey()
      };

      function initState(){
        var storedDomains=loadJSON(STORAGE_KEY_DOMAINS,null);
        if(!storedDomains||!Array.isArray(storedDomains)||!storedDomains.length){
          state.domains=defaultDomains.map(function(d){
            return{name:d.name,sub:d.sub.slice(0)};
          });
          saveJSON(STORAGE_KEY_DOMAINS,state.domains);
        }else{
          state.domains=storedDomains;
        }

        state.weeklyScores=loadJSON(STORAGE_KEY_WEEKLY,{});
        state.monthlyScores=loadJSON(STORAGE_KEY_MONTHLY,{});
        state.tasksByDate=loadJSON(STORAGE_KEY_TASKS,{});

        if(!state.weeklyScores[state.weekKey])state.weeklyScores[state.weekKey]={};
        if(!state.monthlyScores[state.monthKey])state.monthlyScores[state.monthKey]={};

        state.domains.forEach(function(_,idx){
          if(typeof state.weeklyScores[state.weekKey][idx]!=="number")
            state.weeklyScores[state.weekKey][idx]=0;
          if(!state.monthlyScores[state.monthKey][idx])
            state.monthlyScores[state.monthKey][idx]={};
          state.domains[idx].sub.forEach(function(_,sIdx){
            if(typeof state.monthlyScores[state.monthKey][idx][sIdx]!=="number")
              state.monthlyScores[state.monthKey][idx][sIdx]=0;
          });
        });

        ensureTasksForToday();
      }

      var todayContainer=document.getElementById("todayContent"),
          weeklyContainer=document.getElementById("weeklyDomains"),
          monthlyContainer=document.getElementById("monthlyDomains"),
          settingsContainer=document.getElementById("settingsDomains"),
          insightsContainer=document.getElementById("insightsContent"),
          periodLabel=document.getElementById("periodLabel"),
          toastEl=document.getElementById("toast"),
          radarCanvas=document.getElementById("weeklyRadar"),
          views={
            todayView:document.getElementById("todayView"),
            weeklyView:document.getElementById("weeklyView"),
            insightsView:document.getElementById("insightsView"),
            monthlyView:document.getElementById("monthlyView"),
            settingsView:document.getElementById("settingsView")
          };

      var toastTimer=null;
      function showToast(msg){
        toastEl.textContent=msg||"Saved ‚úì";
        if(toastTimer){clearTimeout(toastTimer);toastTimer=null}
        toastEl.classList.add("visible");
        toastTimer=setTimeout(function(){
          toastEl.classList.remove("visible");
        },900);
      }

      function updatePeriodLabel(){
        periodLabel.textContent="Week "+state.weekKey+" ¬∑ Month "+state.monthKey+" ¬∑ "+APP_VERSION;
      }

      // --- Neglect & momentum helpers ---

      function deriveNeglect(score){
        if(score>=7) return "none";
        if(score>=4) return "medium";
        return "serious";
      }

      function computeWeeklyMomentum(){
        var wk = state.weeklyScores[state.weekKey] || {};
        var domains = state.domains;
        if(!domains.length) return 0;
        var total=0, count=0;
        domains.forEach(function(_,idx){
          var v = typeof wk[idx]==="number" ? wk[idx] : 0;
          total += v;
          count++;
        });
        if(!count) return 0;
        var avg = total / count;     // 0..10
        var m = (avg - 5) / 5;       // map to -1..+1
        if(m > 1) m = 1;
        if(m < -1) m = -1;
        return m;
      }

      // --- Task generation & rendering ---

      function ensureTasksForToday(){
        var todayKey = state.todayKey;
        if(!state.tasksByDate[todayKey]){
          state.tasksByDate[todayKey]={micro:[],standard:[],deep:[]};
        }
        var pack = state.tasksByDate[todayKey];
        var hasAny = (pack.micro && pack.micro.length) ||
                     (pack.standard && pack.standard.length) ||
                     (pack.deep && pack.deep.length);
        if(hasAny){
          return; // don't overwrite existing tasks for today
        }

        var wk = state.weeklyScores[state.weekKey] || {};
        var domains = state.domains;

        var domainInfo = domains.map(function(dom, idx){
          var score = typeof wk[idx]==="number" ? wk[idx] : 0;
          var neglect = deriveNeglect(score);
          var neglectRank = (neglect==="serious"?2:(neglect==="medium"?1:0));
          return {
            idx: idx,
            name: dom.name,
            score: score,
            neglect: neglect,
            neglectRank: neglectRank
          };
        });

        // Sort by neglect rank desc, then score asc (worst first)
        domainInfo.sort(function(a,b){
          if(b.neglectRank!==a.neglectRank){
            return b.neglectRank - a.neglectRank;
          }
          return a.score - b.score;
        });

        // Filter to those with any neglect; if none, just use all
        var neglected = domainInfo.filter(function(d){ return d.neglect!=="none"; });
        var focus = neglected.length ? neglected : domainInfo;

        // Take up to 2 focus domains (for 2 micro tasks)
        focus = focus.slice(0,2);

        pack.micro = [];
        pack.standard = [];
        pack.deep = pack.deep || [];

        // Micro: 1 per focus domain (2 micro tasks)
        focus.forEach(function(d,i){
          var idBase = todayKey+"-"+d.idx+"-"+i;

          pack.micro.push({
            id: idBase+"-m",
            domainIdx: d.idx,
            difficulty: "micro",
            label: "Do one small 5‚Äì10 min action for "+d.name+" (your choice).",
            energyCost: 3,
            expectedDuration: 10,
            state: "pending"
          });
        });

        // Standard: 1 for the worst focus domain (if any focus)
        if(focus.length){
          var worst = focus[0];
          var idStd = todayKey+"-"+worst.idx+"-std";
          pack.standard.push({
            id: idStd,
            domainIdx: worst.idx,
            difficulty: "standard",
            label: "Spend 15‚Äì20 mins deliberately improving "+worst.name+" in a concrete way.",
            energyCost: 5,
            expectedDuration: 20,
            state: "pending"
          });
        }

        // Deep: 1 for the best-scoring domain, only if momentum is decent
        var momentum = computeWeeklyMomentum();
        if(momentum >= 0.3 && domainInfo.length){
          // best-scoring domain = sort by score desc
          var sortedByScore = domainInfo.slice().sort(function(a,b){
            return b.score - a.score;
          });
          var best = sortedByScore[0];
          var idDeep = todayKey+"-"+best.idx+"-deep";
          pack.deep.push({
            id: idDeep,
            domainIdx: best.idx,
            difficulty: "deep",
            label: "Optional 20‚Äì30 min deep block for "+best.name+" (only if you have the energy).",
            energyCost: 7,
            expectedDuration: 25,
            state: "pending"
          });
        }

        state.tasksByDate[todayKey] = pack;
        saveJSON(STORAGE_KEY_TASKS,state.tasksByDate);
      }

      function renderTasksToday(container){
        var todayKey = state.todayKey;
        var pack = state.tasksByDate[todayKey];
        if(!pack){
          return;
        }

        var hasAny = (pack.micro && pack.micro.length) ||
                     (pack.standard && pack.standard.length) ||
                     (pack.deep && pack.deep.length);

        var card=document.createElement("div");
        card.className="card";

        var header=document.createElement("div");
        header.className="card-header";

        var title=document.createElement("div");
        title.className="card-title";
        title.textContent="Today‚Äôs tasks";

        header.appendChild(title);
        card.appendChild(header);

        var body=document.createElement("div");
        body.className="task-stack";

        if(!hasAny){
          var msg=document.createElement("div");
          msg.className="insights-secondary";
          msg.textContent="No tasks generated yet.";
          body.appendChild(msg);
        }else{
          function addGroup(titleText, list, difficultyLabel){
            if(!list || !list.length) return;
            var gTitle=document.createElement("div");
            gTitle.className="task-group-title";
            gTitle.textContent=titleText;
            body.appendChild(gTitle);

            list.forEach(function(task){
              var row=document.createElement("div");
              row.className="task-row";
              if(task.state==="done"){
                row.classList.add("task-done");
              }

              var checkbox=document.createElement("input");
              checkbox.type="checkbox";
              checkbox.className="task-checkbox";
              checkbox.checked = (task.state==="done");

              checkbox.addEventListener("change",function(){
                task.state = checkbox.checked ? "done" : "pending";
                if(task.state==="done"){
                  row.classList.add("task-done");
                }else{
                  row.classList.remove("task-done");
                }
                saveJSON(STORAGE_KEY_TASKS,state.tasksByDate);
              });

              var main=document.createElement("div");
              main.className="task-main";

              var label=document.createElement("div");
              label.className="task-label";
              label.textContent=task.label;

              var meta=document.createElement("div");
              meta.className="task-meta";
              meta.textContent=difficultyLabel+" ¬∑ ~"+task.expectedDuration+" mins ¬∑ energy "+task.energyCost+"/10";

              var chip=document.createElement("div");
              chip.className="task-domain-chip";
              var domName = (state.domains[task.domainIdx] && state.domains[task.domainIdx].name) || "Domain";
              chip.textContent=domName;

              main.appendChild(label);
              main.appendChild(meta);
              main.appendChild(chip);

              row.appendChild(checkbox);
              row.appendChild(main);

              body.appendChild(row);
            });
          }

          addGroup("Micro (5‚Äì10 mins)", pack.micro, "Micro");
          addGroup("Standard (15‚Äì20 mins)", pack.standard, "Standard");
          addGroup("Deep (20‚Äì30+ mins)", pack.deep, "Deep");
        }

        card.appendChild(body);
        container.appendChild(card);
      }

      // --- TODAY RENDERING ---

      function renderToday(){
        if(!todayContainer)return;
        todayContainer.innerHTML="";

        var wk = state.weeklyScores[state.weekKey] || {};
        var domains = state.domains;
        if(!domains.length) return;

        var scores = domains.map(function(dom, idx){
          var cur = typeof wk[idx]==="number" ? wk[idx] : 0;
          return cur;
        });

        var total=0, count=0;
        scores.forEach(function(v){total+=v;count++;});
        var avg = count ? (total/count) : 0;
        var avgDisplay = avg.toFixed(1);

        var maxScore=-Infinity, minScore=Infinity;
        var maxIdx=0, minIdx=0;
        scores.forEach(function(v,idx){
          if(v>maxScore){maxScore=v;maxIdx=idx;}
          if(v<minScore){minScore=v;minIdx=idx;}
        });

        // Summary card
        var summaryCard=document.createElement("div");
        summaryCard.className="card";

        var summaryHeader=document.createElement("div");
        summaryHeader.className="card-header";

        var summaryTitle=document.createElement("div");
        summaryTitle.className="card-title";
        summaryTitle.textContent="Today at a glance";

        var summaryValue=document.createElement("div");
        summaryValue.className="card-value";
        summaryValue.textContent="Avg "+avgDisplay+"/10";

        summaryHeader.appendChild(summaryTitle);
        summaryHeader.appendChild(summaryValue);
        summaryCard.appendChild(summaryHeader);

        var summaryBody=document.createElement("div");
        summaryBody.className="today-stack";

        var bestLine=document.createElement("div");
        bestLine.className="insights-secondary";
        bestLine.textContent="Strongest: "+domains[maxIdx].name+" ("+maxScore+"/10)";

        var worstLine=document.createElement("div");
        worstLine.className="insights-secondary";
        worstLine.textContent="Weakest: "+domains[minIdx].name+" ("+minScore+"/10)";

        summaryBody.appendChild(bestLine);
        summaryBody.appendChild(worstLine);
        summaryCard.appendChild(summaryBody);

        todayContainer.appendChild(summaryCard);

        // Domain cards (simple list in one card)
        var domainsCard=document.createElement("div");
        domainsCard.className="card";

        var domainsHeader=document.createElement("div");
        domainsHeader.className="card-header";

        var domainsTitle=document.createElement("div");
        domainsTitle.className="card-title";
        domainsTitle.textContent="Domains today";

        domainsHeader.appendChild(domainsTitle);
        domainsCard.appendChild(domainsHeader);

        var domainsBody=document.createElement("div");
        domainsBody.className="today-stack";

        domains.forEach(function(dom,idx){
          var score = scores[idx];
          var neglect = deriveNeglect(score);

          var row=document.createElement("div");
          row.className="today-domain-row";

          var label=document.createElement("div");
          label.className="today-domain-label";
          label.textContent=dom.name;

          var right=document.createElement("div");
          right.className="today-domain-score";

          var scoreText=document.createElement("span");
          scoreText.textContent=score+"/10";

          var badge=document.createElement("span");
          badge.className="badge-neglect";
          if(neglect==="none"){
            badge.classList.add("badge-none");
            badge.textContent="no neglect";
          }else if(neglect==="medium"){
            badge.classList.add("badge-medium");
            badge.textContent="medium neglect";
          }else{
            badge.classList.add("badge-serious");
            badge.textContent="serious neglect";
          }

          right.appendChild(scoreText);
          right.appendChild(badge);

          row.appendChild(label);
          row.appendChild(right);

          domainsBody.appendChild(row);
        });

        domainsCard.appendChild(domainsBody);
        todayContainer.appendChild(domainsCard);

        // Tasks card
        renderTasksToday(todayContainer);
      }

      // --- WEEKLY / MONTHLY / SETTINGS / INSIGHTS ---

      function renderWeekly(){
        weeklyContainer.innerHTML="";
        var wk=state.weeklyScores[state.weekKey];

        state.domains.forEach(function(dom,idx){
          var val=typeof wk[idx]==="number"?wk[idx]:0;

          var card=document.createElement("div");
          card.className="card";

          var head=document.createElement("div");
          head.className="card-header";

          var title=document.createElement("div");
          title.className="card-title";
          var subsStr=(dom.sub&&dom.sub.length)?" ("+dom.sub.join(", ")+")":"";
          title.textContent=dom.name+subsStr;

          var value=document.createElement("div");
          value.className="card-value";
          value.textContent=val+"/10";

          head.appendChild(title);
          head.appendChild(value);

          var body=document.createElement("div");
          body.className="slider-row";

          var slider=document.createElement("input");
          slider.type="range";
          slider.min="0";
          slider.max="10";
          slider.step="1";
          slider.value=val;
          slider.setAttribute("data-domain-idx",idx);

          slider.addEventListener("input",function(e){
            var v=parseInt(e.target.value,10)||0;
            state.weeklyScores[state.weekKey][idx]=v;
            value.textContent=v+"/10";
            saveJSON(STORAGE_KEY_WEEKLY,state.weeklyScores);
            drawRadarFromState();
            renderInsights();
            renderToday();
            showToast("Saved ‚úì");
          });

          body.appendChild(slider);
          card.appendChild(head);
          card.appendChild(body);
          weeklyContainer.appendChild(card);
        });
      }

      function renderMonthly(){
        monthlyContainer.innerHTML="";
        var mk=state.monthlyScores[state.monthKey];

        state.domains.forEach(function(dom,idx){
          var card=document.createElement("div");
          card.className="card";

          var head=document.createElement("div");
          head.className="card-header";

          var title=document.createElement("div");
          title.className="card-title";
          title.textContent=dom.name;

          head.appendChild(title);
          card.appendChild(head);

          var body=document.createElement("div");
          body.className="slider-row";

          dom.sub.forEach(function(subName,sIdx){
            if(!mk[idx])mk[idx]={};
            if(typeof mk[idx][sIdx]!=="number")mk[idx][sIdx]=0;
            var val=mk[idx][sIdx];

            var label=document.createElement("label");
            label.textContent=subName;

            var slider=document.createElement("input");
            slider.type="range";
            slider.min="0";
            slider.max="10";
            slider.step="1";
            slider.value=val;
            slider.setAttribute("data-domain-idx",idx);
            slider.setAttribute("data-sub-idx",sIdx);

            var sv=document.createElement("div");
            sv.className="slider-value-label";
            sv.textContent="Current: "+val;

            slider.addEventListener("input",function(e){
              var v=parseInt(e.target.value,10)||0;
              if(!state.monthlyScores[state.monthKey][idx])
                state.monthlyScores[state.monthKey][idx]={};
              state.monthlyScores[state.monthKey][idx][sIdx]=v;
              sv.textContent="Current: "+v;
              saveJSON(STORAGE_KEY_MONTHLY,state.monthlyScores);
              showToast("Saved ‚úì");
            });

            body.appendChild(label);
            body.appendChild(slider);
            body.appendChild(sv);
          });

          card.appendChild(body);
          monthlyContainer.appendChild(card);
        });
      }

      function renderSettings(){
        settingsContainer.innerHTML="";
        state.domains.forEach(function(dom,idx){
          var group=document.createElement("div");
          group.className="settings-group";

          var row1=document.createElement("div");
          row1.className="settings-row";

          var inputName=document.createElement("input");
          inputName.type="text";
          inputName.value=dom.name;
          inputName.placeholder="Domain name";

          inputName.addEventListener("change",function(e){
            state.domains[idx].name=e.target.value||("Domain "+(idx+1));
            saveJSON(STORAGE_KEY_DOMAINS,state.domains);
            cleanupScores();
            renderWeekly();
            renderMonthly();
            drawRadarFromState();
            renderInsights();
            renderToday();
            showToast("Saved ‚úì");
          });

          var removeBtn=document.createElement("button");
          removeBtn.textContent="Remove";
          removeBtn.addEventListener("click",function(){
            if(state.domains.length<=3){
              alert("Keep at least three domains.");
              return;
            }
            state.domains.splice(idx,1);
            saveJSON(STORAGE_KEY_DOMAINS,state.domains);
            cleanupScores();
            renderAll();
            showToast("Saved ‚úì");
          });

          row1.appendChild(inputName);
          row1.appendChild(removeBtn);

          var row2=document.createElement("div");
          row2.className="settings-row";

          var inputSub=document.createElement("input");
          inputSub.type="text";
          inputSub.value=dom.sub.join(", ");
          inputSub.placeholder="Subdomains (comma separated)";

          inputSub.addEventListener("change",function(e){
            var raw=e.target.value||"";
            var parts=raw.split(",").map(function(s){return s.trim()}).filter(Boolean);
            if(!parts.length)parts=["Aspect 1","Aspect 2","Aspect 3"];
            state.domains[idx].sub=parts;
            saveJSON(STORAGE_KEY_DOMAINS,state.domains);
            cleanupScores();
            renderMonthly();
            renderWeekly();
            drawRadarFromState();
            renderInsights();
            renderToday();
            showToast("Saved ‚úì");
          });

          row2.appendChild(inputSub);
          group.appendChild(row1);
          group.appendChild(row2);
          settingsContainer.appendChild(group);
        });
      }

      function cleanupScores(){
        Object.keys(state.weeklyScores).forEach(function(weekKey){
          var wk=state.weeklyScores[weekKey];
          var newW={};
          state.domains.forEach(function(_,idx){
            newW[idx]=typeof wk[idx]==="number"?wk[idx]:0;
          });
          state.weeklyScores[weekKey]=newW;
        });

        Object.keys(state.monthlyScores).forEach(function(monthKey){
          var mk=state.monthlyScores[monthKey];
          var newM={};
          state.domains.forEach(function(dom,idx){
            newM[idx]=newM[idx]||{};
            dom.sub.forEach(function(_,sIdx){
              if(!mk[idx])mk[idx]={};
              newM[idx][sIdx]=typeof mk[idx][sIdx]==="number"?mk[idx][sIdx]:0;
            });
          });
          state.monthlyScores[monthKey]=newM;
        });

        saveJSON(STORAGE_KEY_WEEKLY,state.weeklyScores);
        saveJSON(STORAGE_KEY_MONTHLY,state.monthlyScores);
      }

      function drawRadarFromState(){
        if(!radarCanvas)return;
        var wk=state.weeklyScores[state.weekKey]||{};
        var labels=state.domains.map(function(d){return d.name});
        var vals=state.domains.map(function(_,idx){
          var v=wk[idx];
          return typeof v==="number"?v:0;
        });
        drawRadar(radarCanvas,labels,vals);
      }

      function wrapTextLines(ctx,text,maxWidth){
        var words=text.split(" ");
        var lines=[];
        var current=words[0]||"";
        for(var i=1;i<words.length;i++){
          var test=current+" "+words[i];
          if(ctx.measureText(test).width<=maxWidth){
            current=test;
          }else{
            lines.push(current);
            current=words[i];
          }
        }
        lines.push(current);
        return lines;
      }

      function drawRadar(canvas,labels,values){
        var n=labels.length;
        if(!n)return;

        var dpr=window.devicePixelRatio||1;
        var rect=canvas.getBoundingClientRect();
        var size=Math.min(rect.width||260,320)*0.7;
        canvas.width=size*dpr;
        canvas.height=size*dpr;

        var ctx=canvas.getContext("2d");
        ctx.setTransform(dpr,0,0,dpr,0,0);
        ctx.clearRect(0,0,size,size);

        var cx=size/2,cy=size/2;
        var radius=size*0.42;
        var maxVal=10;
        var step=(Math.PI*2)/n;
        var base=-Math.PI/2;

        ctx.strokeStyle="#e5e7eb";
        ctx.lineWidth=1;
        var rings=4;
        for(var r=1;r<=rings;r++){
          ctx.beginPath();
          var rr=radius*r/rings;
          ctx.arc(cx,cy,rr,0,Math.PI*2);
          ctx.stroke();
        }

        for(var i=0;i<n;i++){
          var angle=base+step*i;
          var x=cx+radius*Math.cos(angle);
          var y=cy+radius*Math.sin(angle);
          ctx.beginPath();
          ctx.moveTo(cx,cy);
          ctx.lineTo(x,y);
          ctx.stroke();
        }

        ctx.fillStyle="#1f2933";
        ctx.font="9px -apple-system,BlinkMacSystemFont,system-ui";
        var labelRadius=radius*0.93;
        var maxLabelWidth=radius*0.6;

        for(var j=0;j<n;j++){
          var startAng=base+step*j;
          var centerAng=startAng+step/2;
          var lx=cx+labelRadius*Math.cos(centerAng);
          var ly=cy+labelRadius*Math.sin(centerAng);

          var text=labels[j];
          var lines=wrapTextLines(ctx,text,maxLabelWidth);
          var lineHeight=10;

          var ca=Math.cos(centerAng);
          var align;
          if(Math.abs(ca)<0.15){
            align="center";
          }else if(ca>0){
            align="right";
          }else{
            align="left";
          }
          ctx.textAlign=align;

          var baselineShift=(lines.length-1)*lineHeight/2;
          for(var li=0;li<lines.length;li++){
            var offsetY=-baselineShift+li*lineHeight;
            ctx.textBaseline="middle";
            ctx.fillText(lines[li],lx,ly+offsetY);
          }
        }

        for(var k=0;k<n;k++){
          var v=values[k];
          if(v<=0)continue;
          if(v>maxVal)v=maxVal;
          var rrVal=radius*(v/maxVal);

          var segStart=base+step*k;
          var segEnd=segStart+step;

          ctx.beginPath();
          ctx.moveTo(cx,cy);
          ctx.arc(cx,cy,rrVal,segStart,segEnd);
          ctx.closePath();
          ctx.fillStyle="rgba(93,168,255,0.23)";
          ctx.fill();
          ctx.strokeStyle="rgba(37,99,235,0.9)";
          ctx.lineWidth=1;
          ctx.stroke();
        }
      }

      function renderInsights(){
        if(!insightsContainer)return;
        insightsContainer.innerHTML="";

        var wk = state.weeklyScores[state.weekKey] || {};
        var prevKey = getPreviousWeekKeyFromToday();
        var prevWeek = state.weeklyScores[prevKey] || null;

        var domains = state.domains;
        if(!domains.length)return;

        var scores = domains.map(function(dom, idx){
          var cur = typeof wk[idx]==="number" ? wk[idx] : 0;
          return cur;
        });

        var total=0, count=0;
        scores.forEach(function(v){
          total+=v;
          count++;
        });
        var avg = count? (total/count):0;
        var avgDisplay = avg.toFixed(1);

        var maxScore=-Infinity, minScore=Infinity;
        var maxIdx=0, minIdx=0;
        scores.forEach(function(v,idx){
          if(v>maxScore){maxScore=v;maxIdx=idx;}
          if(v<minScore){minScore=v;minIdx=idx;}
        });

        // Summary card
        var summaryCard=document.createElement("div");
        summaryCard.className="card";

        var summaryHeader=document.createElement("div");
        summaryHeader.className="card-header";

        var summaryTitle=document.createElement("div");
        summaryTitle.className="card-title";
        summaryTitle.textContent="This week at a glance";

        var summaryValue=document.createElement("div");
        summaryValue.className="card-value";
        summaryValue.textContent="Avg "+avgDisplay+"/10";

        summaryHeader.appendChild(summaryTitle);
        summaryHeader.appendChild(summaryValue);
        summaryCard.appendChild(summaryHeader);

        var summaryBody=document.createElement("div");
        summaryBody.className="insights-stack";

        var bestLine=document.createElement("div");
        bestLine.className="insights-secondary";
        bestLine.textContent="Strongest: "+domains[maxIdx].name+" ("+maxScore+"/10)";

        var worstLine=document.createElement("div");
        worstLine.className="insights-secondary";
        worstLine.textContent="Weakest: "+domains[minIdx].name+" ("+minScore+"/10)";

        summaryBody.appendChild(bestLine);
        summaryBody.appendChild(worstLine);
        summaryCard.appendChild(summaryBody);

        insightsContainer.appendChild(summaryCard);

        // Deltas card
        var deltasCard=document.createElement("div");
        deltasCard.className="card";

        var deltasHeader=document.createElement("div");
        deltasHeader.className="card-header";

        var deltasTitle=document.createElement("div");
        deltasTitle.className="card-title";
        deltasTitle.textContent="Week-over-week change";

        deltasHeader.appendChild(deltasTitle);
        deltasCard.appendChild(deltasHeader);

        var deltasBody=document.createElement("div");
        deltasBody.className="insights-stack";

        var deltasData = [];

        domains.forEach(function(dom,idx){
          var cur = scores[idx];
          var prevVal = prevWeek && typeof prevWeek[idx]==="number" ? prevWeek[idx] : null;
          var delta = (prevVal===null)? null : (cur - prevVal);

          deltasData.push({idx:idx,cur:cur,prev:prevVal,delta:delta});

          var row=document.createElement("div");
          row.className="insights-row";

          var label=document.createElement("div");
          label.className="insights-label";
          label.textContent=dom.name;

          var right=document.createElement("div");
          right.style.display="flex";
          right.style.alignItems="baseline";

          var scoreEl=document.createElement("div");
          scoreEl.className="insights-score";
          scoreEl.textContent=cur+"/10";

          var deltaEl=document.createElement("div");
          deltaEl.className="insights-delta";

          if(delta===null){
            deltaEl.textContent="‚Äì";
            deltaEl.style.color="#94a3b8";
          }else if(delta>0){
            deltaEl.textContent="‚ñ≤ +"+delta;
            deltaEl.style.color="#16a34a";
          }else if(delta<0){
            deltaEl.textContent="‚ñº "+delta;
            deltaEl.style.color="#dc2626";
          }else{
            deltaEl.textContent="‚Äì";
            deltaEl.style.color="#94a3b8";
          }

          right.appendChild(scoreEl);
          right.appendChild(deltaEl);

          row.appendChild(label);
          row.appendChild(right);

          deltasBody.appendChild(row);
        });

        deltasCard.appendChild(deltasBody);
        insightsContainer.appendChild(deltasCard);

        // Focus suggestion
        var focusCard=document.createElement("div");
        focusCard.className="card";

        var focusHeader=document.createElement("div");
        focusHeader.className="card-header";

        var focusTitle=document.createElement("div");
        focusTitle.className="card-title";
        focusTitle.textContent="Suggested focus for next week";

        focusHeader.appendChild(focusTitle);
        focusCard.appendChild(focusHeader);

        var focusBody=document.createElement("div");
        focusBody.className="insights-stack";

        var anyData = scores.some(function(v){return v>0;}) ||
                      (prevWeek && Object.keys(prevWeek).length>0);

        if(!anyData){
          var msg=document.createElement("div");
          msg.className="insights-secondary";
          msg.textContent="Not enough weekly data yet. Add some scores to see a focus suggestion.";
          focusBody.appendChild(msg);
        }else{
          var minScoreForFocus = Math.min.apply(null,scores);
          var candidateIndices = [];
          scores.forEach(function(v,idx){
            if(v===minScoreForFocus)candidateIndices.push(idx);
          });

          var focusIdx = candidateIndices[0];
          if(prevWeek){
            var bestIdx = focusIdx;
            var bestDelta = null;
            candidateIndices.forEach(function(ci){
              var d = deltasData[ci].delta;
              if(d===null)return;
              if(bestDelta===null || d<bestDelta){
                bestDelta = d;
                bestIdx = ci;
              }
            });
            focusIdx = bestIdx;
          }

          var fd = deltasData[focusIdx];
          var line1=document.createElement("div");
          line1.className="insights-label";
          line1.textContent=domains[focusIdx].name;

          var line2=document.createElement("div");
          line2.className="insights-secondary";
          var text="Current: "+fd.cur+"/10";
          if(fd.delta!==null && fd.delta!==0){
            text+=" ¬∑ Change vs last week: ";
            if(fd.delta>0){
              text+="‚ñ≤ +"+fd.delta;
            }else{
              text+="‚ñº "+fd.delta;
            }
          }
          line2.textContent=text;

          focusBody.appendChild(line1);
          focusBody.appendChild(line2);
        }

        focusCard.appendChild(focusBody);
        insightsContainer.appendChild(focusCard);
      }

      function bindTabs(){
        var buttons=document.querySelectorAll(".tab-btn");
        buttons.forEach(function(btn){
          btn.addEventListener("click",function(){
            var target=btn.getAttribute("data-view");
            if(!views[target])return;
            Object.keys(views).forEach(function(k){
              views[k].classList.remove("active");
            });
            views[target].classList.add("active");
            buttons.forEach(function(b){b.classList.remove("active")});
            btn.classList.add("active");
          });
        });
      }

      function bindAddDomain(){
        var addBtn=document.getElementById("addDomainBtn");
        addBtn.addEventListener("click",function(){
          var idx=state.domains.length+1;
          state.domains.push({name:"New domain "+idx,sub:["Aspect 1","Aspect 2","Aspect 3"]});
          saveJSON(STORAGE_KEY_DOMAINS,state.domains);
          cleanupScores();
          renderAll();
          showToast("Saved ‚úì");
        });
      }

      function renderAll(){
        updatePeriodLabel();
        renderWeekly();
        renderMonthly();
        renderSettings();
        drawRadarFromState();
        renderInsights();
        renderToday();
      }

      initState();
      bindTabs();
      bindAddDomain();
      renderAll();

      window.addEventListener("resize",function(){
        clearTimeout(window.__lwResizeTimer);
        window.__lwResizeTimer=setTimeout(function(){
          drawRadarFromState();
        },180);
      });

    })();
  </script>
</body>
</html>